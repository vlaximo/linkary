<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Linkary</title>
  <link rel="icon" type="image/png" href="logo-linkary.png" />
      <stop offset="60%" stop-color="#6A63FF"/>
      <stop offset="100%" stop-color="#FF4FB6"/>
    </linearGradient></defs>
    <rect x="4" y="4" width="56" height="56" rx="14" fill="#ffffff"/>
    <path d="M22 24a8 8 0 0 1 8-8h4a8 8 0 0 1 8 8v4h-6v-4a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16a8 8 0 0 1-8 8h-4a8 8 0 0 1-8-8v-4h6v4a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2V24Z" fill="url(%23g)"/>
  </svg>' />
        <stop offset="60%" stop-color="#7B61FF"/>
        <stop offset="100%" stop-color="#FF4FB6"/>
      </linearGradient>
    </defs>
    <rect x="4" y="4" width="56" height="56" rx="14" fill="#0b0f14"/>
    <path d="M22 24a8 8 0 0 1 8-8h4a8 8 0 0 1 8 8v4h-6v-4a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16a8 8 0 0 1-8 8h-4a8 8 0 0 1-8-8v-4h6v4a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2V24Z" fill="url(%23g)"/>
  </svg>'/>
  <meta name="description" content="Guarda, clasifica y comparte tus links con previsualizaciones de reels y videos (Instagram, TikTok, YouTube)." />
  <style>
    :root{
      /* Tema claro basado en el logo */
      --bg:#ffffff;
      --card:#ffffff;
      --text:#182230;
      --muted:#5c6b7d;
      --line:#e7edf5;
      --accentA:#33C3FF; /* azul/cian del logo */
      --accentB:#6A63FF; /* violeta del logo */
      --accentC:#FF4FB6; /* fucsia del logo */
      --accentWarm:#FF6A3D; /* naranja del logo */
      --gradPrimary: linear-gradient(135deg, var(--accentA), var(--accentB) 50%, var(--accentC));
      --gradWarm: linear-gradient(135deg, var(--accentWarm), var(--accentC));
      --ring:#72c8ff66;
      --shadow:0 8px 24px rgba(15,35,55,.08);
      --radius:18px; --danger:#ff5d5d;
    }
    *{box-sizing:border-box}
    html,body{margin:0; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif; color:var(--text); background:var(--bg);} 
    body{margin:0; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif; color:var(--text); 
      background:
        radial-gradient(900px 600px at 15% -10%, rgba(62,166,255,.28), transparent 60%),
        radial-gradient(800px 500px at 110% 10%, rgba(255,79,182,.22), transparent 60%),
        radial-gradient(700px 500px at 60% 120%, rgba(255,106,61,.15), transparent 60%),
        #0b0f14;
    }
    header{position:sticky; top:0; z-index:10; backdrop-filter:saturate(140%) blur(6px); background:rgba(255,255,255,.86); border-bottom:1px solid var(--line);} 
    .wrap{max-width:1200px; margin:0 auto; padding:18px}
    .brand{display:flex; align-items:center; gap:14px}
    .logo{display:none} /* deprecated */
    .logo-img{display:block; width:40px; height:40px; border-radius:12px; background:#ffffff; border:1px solid var(--line); box-shadow:0 2px 8px rgba(0,0,0,.06)}
    @media (max-width:680px){ .logo-img{width:36px; height:36px; border-radius:10px} } 
    h1{font-size:20px; margin:0}
    .actions{display:flex; gap:10px; margin-left:auto}
    .bar{display:flex; align-items:center; gap:14px}
    input[type="search"], input[type="text"], input[type="url"], textarea, select{padding:12px 14px; border-radius:12px; border:1px solid var(--line); background:#f7f9fc; color:var(--text); outline:none} 
    input[type="search"]{flex:1; min-width:230px}
    input[type="search"]:focus, input:focus, textarea:focus, select:focus{box-shadow:0 0 0 4px var(--ring); border-color:#c8dcff} 
    .btn{padding:10px 14px; border-radius:12px; background:#f1f5fb; color:#213047; border:1px solid var(--line); cursor:pointer}
    .btn:hover{background:#eaf0ff} 
    .btn:hover{background:#142540}
    .btn.primary{background:var(--gradPrimary); border:none; color:#fff; font-weight:600} 
    .btn.ghost{background:transparent; border:1px dashed #2f4561}
    .btn.danger{background:#361c1c; border:1px solid #5a2d2d}

    main{padding:18px 18px 60px}
    .grid{max-width:1200px; margin:0 auto; display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:18px}

    .tabs{max-width:1200px; margin:6px auto 16px; display:flex; flex-wrap:wrap; gap:8px}
    .tab{border:1px solid var(--line); background:#f7f9fc; color:var(--text); padding:8px 12px; border-radius:999px; cursor:pointer; font-size:13px} 
    .tab[data-active="true"]{background:var(--gradPrimary); color:#ffffff; border-color:transparent; box-shadow:0 6px 16px rgba(60,120,255,.18)} 
    .tab .badge{margin-left:8px; font-size:11px; opacity:.85; background:#0a1420; padding:2px 6px; border-radius:999px; border:1px solid #22324a}

    .card{position:relative; overflow:hidden; border-radius:var(--radius); background:var(--card); border:1px solid var(--line); box-shadow:var(--shadow); transition:transform .18s ease, box-shadow .18s ease, border-color .18s ease} 
    .card:hover{transform:translateY(-3px); box-shadow:0 18px 40px rgba(0,0,0,.45); border-color:#29435d}
    .media{width:100%; aspect-ratio:16/9; background:#f2f5fb; display:block; border-bottom:1px solid var(--line)} 
    .thumb{width:100%; height:100%; object-fit:cover}
    .content{padding:14px}
    .title{font-weight:600; font-size:16px; line-height:1.25; margin:0 0 6px}
    .desc{font-size:13px; color:var(--muted); margin:0 0 8px; min-height:38px}
    .meta{display:flex; align-items:center; gap:8px; color:var(--muted); font-size:12px}
    .meta img{width:16px; height:16px; border-radius:4px}
    .chip{position:absolute; left:12px; top:12px; font-size:11px; padding:6px 8px; border-radius:999px; border:1px solid var(--line); background:#ffffffcc; color:#334155; backdrop-filter:saturate(140%) blur(6px)} 
    .open{position:absolute; top:12px; right:12px; font-size:12px; background:#ffffffea; color:#1d2a3a; padding:6px 10px; border-radius:12px; text-decoration:none; border:1px solid var(--line); box-shadow:0 4px 14px rgba(0,0,0,.06)}
    .open.reel{right:102px} 
    .open.reel{right:102px}
    .open.reel{right:92px}
    .open:hover{background:rgba(0,0,0,.7)}
    .tools{position:absolute; right:12px; bottom:12px; display:flex; gap:6px}
    .tool{font-size:12px; background:rgba(0,0,0,.45); color:#fff; padding:6px 8px; border-radius:999px; border:1px solid #2a3a52; cursor:pointer}
    .tool:hover{background:rgba(0,0,0,.6)}

    .embed-wrapper{width:100%; aspect-ratio:16/9; overflow:hidden}
    .embed-wrapper.tall{aspect-ratio:9/16}
    .embed-wrapper iframe{width:100%; height:100%; border:0}

    /* Modal base */
    .backdrop{position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; z-index:50}
    .backdrop.active{display:flex}
    .modal{width:min(860px,92vw); background:#ffffff; border:1px solid var(--line); border-radius:16px; box-shadow:var(--shadow); max-height:90vh; display:flex; flex-direction:column} 
    .modal header{position:relative; border-bottom:1px solid #22324a; background:#0f1621}
    .modal .wrap{padding:14px 16px}
    .modal main{padding:0; overflow:auto; -webkit-overflow-scrolling:touch}
    .modal footer{display:flex; justify-content:flex-end; gap:10px; padding:14px 16px; border-top:1px solid var(--line); position:sticky; bottom:0; background:#ffffff} 

    .form{display:grid; grid-template-columns:1fr 1fr; gap:12px; padding:16px}
    .form label{display:flex; flex-direction:column; gap:8px}
    .form .full{grid-column:1 / -1}
    .preview{grid-column:1 / -1; display:flex; align-items:center; gap:12px}
    .preview img{width:180px; height:110px; object-fit:cover; border-radius:12px; border:1px solid #22324a}
    .muted{color:var(--muted); font-size:12px}

    /* ===== Responsive (m√≥vil) ===== */
    @media (max-width: 680px){
      .wrap{padding:12px}
      header .bar{gap:8px; flex-wrap:wrap}
      #search{flex:1 1 100%; min-width:0}
      .btn{padding:10px 12px; border-radius:10px}
      .tabs{gap:6px; margin-top:8px}
      .tab{padding:6px 10px; font-size:12px}
      .grid{grid-template-columns:1fr; gap:14px}
      .card{border-radius:16px}
      .open{padding:5px 8px; font-size:12px}
      .open.reel{right:80px}
      .modal{width:94vw}
      .form{grid-template-columns:1fr; gap:14px}
      .form input, .form textarea, .form select{font-size:16px}
    }
      header .bar{gap:8px; flex-wrap:wrap}
      #search{flex:1 1 100%; min-width:0}
      .btn{padding:8px 12px; border-radius:10px}
      .tabs{gap:6px; margin-top:8px}
      .tab{padding:6px 10px; font-size:12px}
      .grid{grid-template-columns:1fr; gap:14px}
      .card{border-radius:16px}
      .open{padding:5px 8px; font-size:12px}
      .open.reel{right:80px}
      /* FORMS: una sola columna y tipograf√≠a mayor para iOS */
      .modal{width:94vw}
      .form{grid-template-columns:1fr; gap:14px}
      .form input, .form textarea, .form select{font-size:16px}
    }
      header .bar{gap:8px; flex-wrap:wrap}
      #search{flex:1 1 100%; min-width:0}
      .btn{padding:8px 12px; border-radius:10px}
      .tabs{gap:6px; margin-top:8px}
      .tab{padding:6px 10px; font-size:12px}
      .grid{grid-template-columns:1fr; gap:14px}
      .card{border-radius:16px}
      .open{padding:5px 8px; font-size:12px}
      .open.reel{right:80px}
    }

    /* Gestor de categor√≠as */
    .cat-list{padding:16px}
    .cat-item{display:grid; grid-template-columns:1fr auto auto; gap:8px; align-items:center; padding:8px 0; border-bottom:1px dashed #22324a}
    .cat-tools{display:flex; gap:6px}
  </style>
</head>
<body>
  <header>
    <div class="wrap" style="display:flex; align-items:center; gap:14px;">
      <div class="brand"><img src="logo-linkary.png" alt="Linkary logo" class="logo-img" /><h1>Linkary</h1></div>
      <div class="actions" style="margin-left:auto">
        <div class="bar">
          <input id="search" type="search" placeholder="Buscar por t√≠tulo o dominio‚Ä¶ (Ctrl/‚åò+K)" />
          <button class="btn" id="catBtn">üóÇ Categor√≠as</button>
          <button class="btn" id="newBtn">‚ûï Nuevo link</button>
          <button class="btn" id="importBtn">üì• Importar</button>
          <input type="file" id="importFile" accept="application/json,.json" style="display:none" />
          <button class="btn ghost" id="exportBtn">‚¨áÔ∏è Exportar</button>
          <button class="btn primary" id="openAll">Abrir todos</button>
        </div>
      </div>
    </div>
  </header>

  <main>
    <nav class="tabs" id="tabs"></nav>
    <div class="grid" id="grid"></div>
  </main>

  <!-- Modal CRUD Links -->
  <div class="backdrop" id="backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="dlgTitle">
      <header><div class="wrap"><h2 id="dlgTitle" style="margin:0;font-size:18px">Agregar/Editar link</h2></div></header>
      <main>
        <form class="form" id="linkForm">
          <input type="hidden" id="idx" />
          <label class="full">Categor√≠a
            <select id="fCategory"></select>
          </label>
          <label>T√≠tulo
            <input type="text" id="fTitle" required placeholder="Ej. Curso de HTML" />
          </label>
          <label>URL
            <input type="url" id="fUrl" required placeholder="https://‚Ä¶" />
          </label>
          <label class="full">Descripci√≥n
            <textarea id="fDesc" rows="3" placeholder="¬øDe qu√© trata este enlace?"></textarea>
          </label>
          <label class="full">Reel/Video (opcional)
            <input type="url" id="fEmbed" placeholder="URL de Instagram, TikTok o YouTube" />
          </label>
          <label>Imagen por URL (opcional)
            <input type="url" id="fImage" placeholder="https://‚Ä¶/imagen.jpg" />
          </label>
          <label>Imagen local (opcional)
            <input type="file" id="fImageFile" accept="image/*" />
          </label>
          <div class="preview">
            <img id="fPreview" alt="Previsualizaci√≥n" src="" style="display:none" />
            <span class="muted" id="fInfo">Usa **una** de estas opciones: video (reel) o imagen. Si subes local, se guarda en base64 en tu navegador.</span>
            <button class="btn ghost" type="button" id="fClearImg">Quitar imagen</button>
          </div>
        </form>
      </main>
      <footer>
        <button class="btn" id="cancelBtn">Cancelar</button>
        <button class="btn primary" id="saveBtn">Guardar</button>
      </footer>
    </div>
  </div>

  <!-- Modal Gestor de Categor√≠as -->
  <div class="backdrop" id="backdropCats" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="catTitle">
      <header><div class="wrap"><h2 id="catTitle" style="margin:0;font-size:18px">Gestionar categor√≠as</h2></div></header>
      <main>
        <div class="cat-list" id="catList"></div>
        <div class="form">
          <label class="full">Nueva categor√≠a
            <input type="text" id="catNew" placeholder="Ej. Documentaci√≥n interna" />
          </label>
        </div>
      </main>
      <footer>
        <span class="muted" style="margin-right:auto">‚ÄúTodos‚Äù es fija y no se puede editar ni eliminar.</span>
        <button class="btn" id="catClose">Cerrar</button>
        <button class="btn primary" id="catAdd">Agregar</button>
      </footer>
    </div>
  </div>

  <script>
    // ===== Persistencia =====
    const LS_LINKS = 'linkhub:links:v8';
    const LS_CATS  = 'linkhub:cats:v1';

    const DEFAULT_CATS = [
      'Links para estudiar',
      'Links de programadores sin saber programar',
      'Link Hacker',
      'Link para marketing y publicidad',
      'Link para empresas y empleados',
      'Link para emprendedores',
      'Link de Ocio y hobbies',
      'Link I.A.'
    ];

    const DEMO = [
      { id: String(Date.now()),   title: 'Curso de HTML b√°sico', url: 'https://developer.mozilla.org/es/docs/Learn/Getting_started_with_the_web/HTML_basics', image: 'https://images.unsplash.com/photo-1542831371-29b0f74f9713?w=1600&q=80&auto=format&fit=crop', desc: 'Gu√≠a introductoria al lenguaje HTML, ideal para principiantes.', category: 'Links para estudiar' },
      { id: String(Date.now()+1), title: 'OpenAI', url: 'https://openai.com', desc: 'Explora novedades y herramientas de IA.', category: 'Link I.A.' }
    ];

    // ===== Elementos =====
    const $grid = document.getElementById('grid');
    const $tabs = document.getElementById('tabs');
    const $search = document.getElementById('search');
    const $openAll = document.getElementById('openAll');
    const $exportBtn = document.getElementById('exportBtn');
    const $importBtn = document.getElementById('importBtn');
    const $importFile = document.getElementById('importFile');
    const $newBtn = document.getElementById('newBtn');
    const $catBtn = document.getElementById('catBtn');

    const $backdrop = document.getElementById('backdrop');
    const $linkForm = document.getElementById('linkForm');
    const $idx = document.getElementById('idx');
    const $fCategory = document.getElementById('fCategory');
    const $fTitle = document.getElementById('fTitle');
    const $fUrl = document.getElementById('fUrl');
    const $fDesc = document.getElementById('fDesc');
    const $fEmbed = document.getElementById('fEmbed');
    const $fImage = document.getElementById('fImage');
    const $fImageFile = document.getElementById('fImageFile');
    const $fPreview = document.getElementById('fPreview');
    const $fInfo = document.getElementById('fInfo');
    const $fClearImg = document.getElementById('fClearImg');
    const $cancelBtn = document.getElementById('cancelBtn');
    const $saveBtn = document.getElementById('saveBtn');

    const $backdropCats = document.getElementById('backdropCats');
    const $catList = document.getElementById('catList');
    const $catNew = document.getElementById('catNew');
    const $catClose = document.getElementById('catClose');
    const $catAdd = document.getElementById('catAdd');

    // ===== Estado =====
    const state = {
      links: (()=>{ try{ const raw = localStorage.getItem(LS_LINKS); let data = raw? JSON.parse(raw): DEMO; return data.map(x=> ({...x, id: String(x.id ?? (Date.now()+Math.random()))})); } catch { return DEMO } })(),
      categories: (()=>{ try{ const raw = localStorage.getItem(LS_CATS); return raw? JSON.parse(raw): DEFAULT_CATS } catch { return DEFAULT_CATS } })(),
      category: 'Todos',
      filtered: []
    };

    // ===== Utils =====
    const ALL = 'Todos';
    function domainFrom(u){ try{ return new URL(u).hostname.replace('www.','') } catch { return '' } }
    function fallbackImg(u){ const d=domainFrom(u); return d?`https://www.google.com/s2/favicons?domain=${d}&sz=128`:'' }
    function saveLinks(){ localStorage.setItem(LS_LINKS, JSON.stringify(state.links)); }
    function saveCats(){ localStorage.setItem(LS_CATS, JSON.stringify(state.categories)); }

    function ensureScript(id, src){ if(document.getElementById(id)) return; const s=document.createElement('script'); s.id=id; s.src=src; s.async=true; document.body.appendChild(s); }

    function detectEmbed(url){
      if(!url) return null;
      try{ const u = new URL(url); const h = u.hostname.replace('www.','');
        // YouTube
        const ytId = (h.includes('youtube.com') && u.searchParams.get('v')) || (h==='youtu.be' && u.pathname.slice(1));
        if(ytId){ return {provider:'youtube', html:`<iframe src="https://www.youtube.com/embed/${ytId}" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>`, tall:false}; }
        // Instagram (reels, posts)
        if(h.includes('instagram.com')){ ensureScript('instgrm-embed','https://www.instagram.com/embed.js'); return {provider:'instagram', html:`<blockquote class="instagram-media" data-instgrm-permalink="${url}" data-instgrm-version="14" style="margin:0 auto; background:#000;"></blockquote>`, tall:true}; }
        // TikTok
        if(h.includes('tiktok.com')){ ensureScript('tiktok-embed','https://www.tiktok.com/embed.js'); return {provider:'tiktok', html:`<blockquote class="tiktok-embed" cite="${url}" style="max-width:100%;min-width:100%"><section></section></blockquote>`, tall:true}; }
      }catch(e){ return null }
      return null;
    }

    // ===== Render =====
    function countByCat(list){
      const cats = [ALL, ...state.categories];
      const m = Object.fromEntries(cats.map(k=>[k,0]));
      list.forEach(x=>{ const c = (x.category && state.categories.includes(x.category))? x.category : ALL; m[ALL]++; m[c]++ });
      return m;
    }

    function renderTabs(){
      const counts = countByCat(state.links);
      const cats = [ALL, ...state.categories];
      $tabs.innerHTML = cats.map(cat=>{
        const active = state.category===cat;
        return `<button class="tab" data-cat="${cat}" ${active?"data-active='true'":''}>${cat}<span class="badge">${counts[cat]||0}</span></button>`;
      }).join('');
      $tabs.querySelectorAll('.tab').forEach(b=> b.onclick = ()=>{ state.category=b.dataset.cat; renderGrid(); });
    }

    function mediaTpl(item){
      if(item.embedUrl){
        const det = detectEmbed(item.embedUrl);
        if(det){ return `<div class="embed-wrapper ${det.tall?'tall':''}">${det.html}</div>`; }
      }
      const img = item.image || fallbackImg(item.url);
      return img? `<div class="media"><img class="thumb" loading="lazy" src="${img}" alt=""></div>` : `<div class="media"></div>`;
    }

    function cardTpl(item){
      const dom = domainFrom(item.url);
      return `
        <article class="card">
          <span class="chip">${item.category||'Sin categor√≠a'}</span>
          <button type="button" class="open reel" data-open="reel" data-id="${String(item.id)}" title="Abrir reel">Abrir reel</button>
          <a class="open" href="${item.url}" target="_blank" rel="noopener">Abrir</a>
          ${mediaTpl(item)}
          <div class="content">
            <h3 class="title">${item.title}</h3>
            <p class="desc">${item.desc? item.desc: ''}</p>
            <div class="meta">${dom? `<img src="${fallbackImg(item.url)}" alt=""> ${dom}` : ''}</div>
          </div>
          <div class="tools">
            <button type="button" class="tool" data-action="edit" data-id="${String(item.id)}" title="Editar">‚úèÔ∏è</button>
            <button type="button" class="tool" data-action="del" data-id="${String(item.id)}" title="Eliminar">üóë</button>
          </div>
        </article>
      `;
    }

    function renderGrid(){
      const q = ($search.value||'').toLowerCase();
      const filtered = state.links.filter(x=>{
        const text = `${x.title||''} ${x.desc||''} ${domainFrom(x.url)}`.toLowerCase();
        const matchText = !q || text.includes(q);
        const matchCat = state.category===ALL ? true : (x.category===state.category);
        return matchText && matchCat;
      });
      state.filtered = filtered;
      $grid.innerHTML = filtered.map((it)=> cardTpl(it)).join('');
      // Procesa embeds despu√©s del render (si los scripts ya cargaron)
      if(window.instgrm && window.instgrm.Embeds && window.instgrm.Embeds.process){ window.instgrm.Embeds.process(); }
      if(window.tiktokEmbedLoad){ try{ window.tiktokEmbedLoad(); }catch(e){} }
    }

    function render(){ renderTabs(); renderGrid(); }

    // Delegaci√≥n: acciones de tarjetas
    $grid.addEventListener('click', (ev)=>{
      // Bot√≥n de herramientas (editar/eliminar)
      const toolBtn = ev.target.closest('.tool');
      if(toolBtn){
        const id = String(toolBtn.dataset.id||'');
        const act = toolBtn.dataset.action;
        const item = state.links.find(x=> String(x.id)===id);
        if(!item) return;
        if(act==='edit') openForm(item);
        if(act==='del') deleteItem(item);
        return;
      }
      // Bot√≥n Abrir reel
      const reelBtn = ev.target.closest('[data-open="reel"]');
      if(reelBtn){
        const id = String(reelBtn.dataset.id||'');
        const item = state.links.find(x=> String(x.id)===id);
        if(!item) return;
        if(item.embedUrl){ window.open(item.embedUrl, '_blank'); }
        else { alert('No se guard√≥ ning√∫n reel para este link.'); }
      }
    });

    // ===== CRUD Enlaces =====
    function openForm(item){
      $fCategory.innerHTML = state.categories.map(c=>`<option value="${c}">${c}</option>`).join('');
      if(item){
        $idx.value = String(item.id);
        $fCategory.value = (item.category && state.categories.includes(item.category))? item.category : state.categories[0];
        $fTitle.value = item.title||'';
        $fUrl.value = item.url||'';
        $fDesc.value = item.desc||'';
        $fEmbed.value = item.embedUrl || '';
        $fImage.value = item.image && !item.image.startsWith('data:') ? item.image : '';
        if(item.image){ showPreview(item.image); } else { hidePreview(); }
        document.getElementById('dlgTitle').textContent = 'Editar link';
      } else {
        $idx.value = '';
        $fCategory.value = state.categories[0]||'';
        $fTitle.value = '';
        $fUrl.value = '';
        $fDesc.value = '';
        $fEmbed.value = '';
        $fImage.value = '';
        hidePreview();
        document.getElementById('dlgTitle').textContent = 'Agregar link';
      }
      $backdrop.classList.add('active');
      setTimeout(()=> $fTitle.focus(), 0);
    }

    function closeForm(){ $backdrop.classList.remove('active'); }

    function showPreview(src){ if(src){ $fPreview.src = src; $fPreview.style.display = 'block'; } }
    function hidePreview(){ $fPreview.src = ''; $fPreview.style.display = 'none'; }

    // Cargar imagen local ‚Üí dataURL
    $fImageFile.addEventListener('change', async (e)=>{
      const file = e.target.files && e.target.files[0];
      if(!file) return;
      if(!file.type.startsWith('image/')){ alert('Selecciona un archivo de imagen.'); return; }
      if(file.size > 2 * 1024 * 1024){ if(!confirm('La imagen pesa m√°s de 2MB. ¬øContinuar?')) return; }
      const reader = new FileReader();
      reader.onload = ()=>{ const dataUrl = reader.result; $fImage.value = String(dataUrl); showPreview(String(dataUrl)); };
      reader.onerror = ()=> alert('No se pudo leer el archivo.');
      reader.readAsDataURL(file);
    });

    $fImage.addEventListener('input', ()=>{ const v=$fImage.value.trim(); if(v){ showPreview(v); } else { hidePreview(); } });
    $fClearImg.addEventListener('click', ()=>{ $fImage.value=''; $fImageFile.value=''; hidePreview(); });

    function saveForm(){
      if(!$linkForm.reportValidity()) return;
      const data = {
        category: $fCategory.value,
        title: $fTitle.value.trim(),
        url: $fUrl.value.trim(),
        desc: $fDesc.value.trim(),
        embedUrl: $fEmbed.value.trim() || '',
        image: $fImage.value.trim()
      };
      const id = $idx.value ? String($idx.value) : null;
      if(id){
        const pos = state.links.findIndex(x=> String(x.id)===String(id));
        if(pos>=0) state.links[pos] = { id, ...data };
      } else {
        state.links.unshift({ id: String(Date.now()), ...data });
      }
      saveLinks();
      closeForm();
      render();
    }

    function deleteItem(item){
      if(!item) return;
      if(!confirm('¬øEliminar este link?')) return;
      const pos = state.links.findIndex(x=> String(x.id)===String(item.id));
      if(pos>=0){ state.links.splice(pos,1); saveLinks(); render(); }
    }

    // ===== Gestor de Categor√≠as =====
    function openCatManager(){ drawCatList(); $backdropCats.classList.add('active'); setTimeout(()=> $catNew.focus(), 0); }
    function closeCatManager(){ $backdropCats.classList.remove('active'); }

    function drawCatList(){
      $catList.innerHTML = state.categories.map((name, i)=>{
        return `
          <div class="cat-item">
            <input type="text" value="${name}" data-idx="${i}" class="cat-name" />
            <div class="cat-tools">
              <button type="button" class="btn" data-act="rename" data-idx="${i}">Renombrar</button>
              <button type="button" class="btn danger" data-act="del" data-idx="${i}">Eliminar</button>
            </div>
          </div>
        `;
      }).join('');
    }

    $catList.addEventListener('click', (e)=>{
      const btn = e.target.closest('button');
      if(!btn) return;
      const idx = Number(btn.dataset.idx);
      const act = btn.dataset.act;
      if(Number.isNaN(idx) || !act) return;
      if(act==='rename'){
        const input = $catList.querySelector(`input.cat-name[data-idx="${idx}"]`);
        const next = (input?.value||'').trim();
        const prev = state.categories[idx];
        if(!next || next===prev) return;
        if(state.categories.includes(next)) return alert('Ya existe una categor√≠a con ese nombre.');
        state.categories[idx] = next;
        state.links = state.links.map(x=> x.category===prev? {...x, category: next}: x);
        saveCats(); saveLinks(); render(); drawCatList();
      }
      if(act==='del'){
        const toDel = state.categories[idx];
        if(!confirm(`Eliminar la categor√≠a "${toDel}"? Los links se reasignar√°n.`)) return;
        const fallback = state.categories.find((c,j)=> j!==idx) || '';
        state.links = state.links.map(x=> x.category===toDel? {...x, category: fallback }: x);
        state.categories.splice(idx,1);
        saveCats(); saveLinks();
        if(state.category===toDel) state.category = ALL;
        render(); drawCatList();
      }
    });

    function addCategory(name){
      const n = name.trim();
      if(!n) return;
      if(n===ALL) return alert('‚ÄúTodos‚Äù es fija. Elige otro nombre.');
      if(state.categories.includes(n)) return alert('Ya existe esa categor√≠a.');
      state.categories.push(n);
      saveCats(); render(); drawCatList();
    }

    // ===== Eventos base =====
    $newBtn.onclick = ()=> openForm();
    $cancelBtn.onclick = (e)=>{ e.preventDefault(); closeForm(); };
    $saveBtn.onclick = (e)=>{ e.preventDefault(); saveForm(); };
    $backdrop.addEventListener('click', (e)=>{ if(e.target===$backdrop) closeForm(); });

    $catBtn.onclick = ()=> openCatManager();
    $catClose.onclick = ()=> closeCatManager();
    $catAdd.onclick = ()=>{ addCategory($catNew.value); $catNew.value=''; $catNew.focus(); };
    $backdropCats.addEventListener('click', (e)=>{ if(e.target===$backdropCats) closeCatManager(); });

    $search.addEventListener('input', renderGrid);
    window.addEventListener('keydown', (e)=>{
      if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='k'){ e.preventDefault(); $search.focus(); }
      if(e.key==='Escape' && $backdrop.classList.contains('active')) closeForm();
      if(e.key==='Escape' && $backdropCats.classList.contains('active')) closeCatManager();
    });

    $openAll.onclick = ()=>{ (state.filtered.length? state.filtered: state.links).forEach(it=> window.open(it.url,'_blank')); };

    $exportBtn.onclick = ()=>{
      const blob = new Blob([JSON.stringify(state.links, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='mis_enlaces.json'; a.click(); URL.revokeObjectURL(url);
    };

    // ===== Importar JSON =====
    $importBtn.onclick = ()=> $importFile.click();
    $importFile.onchange = async (e)=>{
      const file = e.target.files && e.target.files[0];
      if(!file) return;
      try{
        const text = await file.text();
        const data = JSON.parse(text);
        if(Array.isArray(data)){
          if(!data.every(x=> typeof x.url==='string')) throw new Error('El JSON no parece ser una lista v√°lida de enlaces.');
          state.links = data.map(x=> ({ id: String(x.id || Date.now()+Math.random()), ...x }));
          saveLinks(); render(); alert(`Importado ${state.links.length} enlaces.`);
        } else if (data && (Array.isArray(data.links) || Array.isArray(data.categories))){
          if(Array.isArray(data.categories)){ state.categories = data.categories.filter(Boolean); saveCats(); }
          if(Array.isArray(data.links)){ state.links = data.links.map(x=> ({ id: String(x.id || Date.now()+Math.random()), ...x })); saveLinks(); }
          render(); alert(`Importaci√≥n completa. Enlaces: ${state.links.length}${Array.isArray(data.categories)?`, Categor√≠as: ${state.categories.length}`:''}`);
        } else { throw new Error('Formato no reconocido. Usa una lista de enlaces o un objeto {links, categories}.'); }
      } catch(err){ console.warn('Error al importar:', err); alert('No se pudo importar el JSON: '+ err.message); }
      finally { $importFile.value = ''; }
    };

    // ===== Init =====
    render();

    // ===== Tests (consola) =====
    (function runTests(){
      try{
        const tests=[]; const assert=(n,c)=>tests.push({n,ok:!!c});
        assert('Renderiza pesta√±as', $tabs.children.length === (1 + state.categories.length));
        assert('Renderiza tarjetas', $grid.children.length>0);
        // Test YouTube embed detection
        const detYT = detectEmbed('https://youtu.be/dQw4w9WgXcQ');
        assert('Detecta YouTube', detYT && detYT.provider==='youtube');
        // Test imagen base64
        const gif1px = 'data:image/gif;base64,R0lGODlhAQABAIAAAAUEBAgAAA7';
        state.links.unshift({id: '777777', title:'Test Img Local', url:'https://ejemplo.com', image: gif1px, desc:'img local', category: state.categories[0]});
        saveLinks(); renderGrid();
        assert('Acepta dataURL como imagen', $grid.innerHTML.includes('data:image/gif;base64'));
        // Test eliminar link
        const testId='999999'; state.links.unshift({id:testId, title:'Eliminar', url:'https://ejemplo.com', desc:'t', category: state.categories[0]}); saveLinks();
        const before=state.links.length; const p=state.links.findIndex(x=>x.id===testId); if(p>-1){ state.links.splice(p,1); }
        saveLinks(); renderGrid(); const after=state.links.length; assert('Eliminar link actualiza lista', after===before-1);
        // Limpieza test
        const pos = state.links.findIndex(x=>x.id==='777777'); if(pos>-1){ state.links.splice(pos,1); saveLinks(); renderGrid(); }
        const ok = tests.filter(t=>t.ok).length; const fail = tests.length-ok; console.log('Linkary Tests'); tests.forEach(t=>console.log(`${t.ok?'‚úÖ':'‚ùå'} ${t.n}`)); if(fail) console.warn(`Fallaron ${fail}/${tests.length}`);
      }catch(err){ console.warn('Error en pruebas:', err); }
    })();
  </script>
</body>
</html>
